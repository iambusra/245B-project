<!DOCTYPE html>
<html>
<head>
  <title>Language Study</title>

  <!-- Load jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />

  <!-- Plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <!-- Stimuli -->
  <script src="stims.js"></script>

  <!-- Style -->
  <style>
    #jspsych-progressbar-container {
      background-color: #eee;
      border-radius: 12px;
      height: 20px;
      margin: 20px auto;
      width: 80%;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    #jspsych-progressbar-inner {
      background: linear-gradient(90deg, #fd53ab 0%, #ee55ae 100%);
      height: 100%;
      border-radius: 12px;
      transition: width 0.4s ease-in-out;
    }
  </style>
</head>

<body>
  <script>
    const jsPsych = initJsPsych({
      show_progress_bar: true,
      auto_update_progress_bar: false
    });

    const myStimuli = jsPsych.randomization.shuffle(experimentStimuli);
    const timeline = [];

    // Instructions
    const instructions = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="content">
          <h2>Welcome</h2>
          <p>You will read short dialogues and sentences, followed by comprehension questions.</p>
          <p>Press the <strong>SPACEBAR</strong> to proceed.</p>
        </div>`,
      choices: [' ']
    };
    timeline.push(instructions);

    // Trial generation
    function createTrial(item, index) {
      const trial = [];

      // 1. Show dialogue
      trial.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p style="font-size: 20px; white-space: pre-line;">${item.dialogue}</p><p><br><em>Press SPACEBAR to continue</em></p>`,
        choices: [' ']
      });

      // 2. Fixation
      trial.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p style="font-size: 32px;">+</p>',
        choices: "NO_KEYS",
        trial_duration: 500
      });

      // 3. Word-by-word SPR sentence
      item.sentence.forEach((word, i) => {
        trial.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size: 32px;">${word}</p>`,
          choices: [' '],
          data: {
            class: item.class,
            item_id: item.item_id,
            condition: item.condition,
            word_number: i + 1,
            word: word,
            sentence_index: index + 1
          },
          on_start: function () {
            jsPsych.setProgressBar((index + i / item.sentence.length) / myStimuli.length);
          }
        });
      });

      // 4. Comprehension question
      trial.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>${item.comprehension_question}</p><p><strong>T</strong> for True, <strong>F</strong> for False</p>`,
        choices: ['t', 'f'],
        data: {
          class: item.class,
          item_id: item.item_id,
          condition: item.condition,
          type: "comprehension",
          correct_response: item.expected_response
        },
        on_finish: function(data) {
          data.response_correct = (data.response?.toUpperCase() === data.correct_response.toUpperCase());
        }
      });

      return trial;
    }

    // Add all trials
    myStimuli.forEach((item, i) => {
      timeline.push(...createTrial(item, i));
    });

    // Completion message
    const completion = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="content">
          <h2>Thank you!</h2>
          <p>The experiment is complete.</p>
          <p>Press SPACEBAR to view your data.</p>
        </div>`,
      choices: [' '],
      on_finish: function () {
        jsPsych.data.displayData();
      }
    };
    timeline.push(completion);

    // Save data to OSF
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    const save_data = {
      type: jsPsychPipe,
      action: "save",
      experiment_id: "kmddDMNYDI1g",
      filename: filename,
      data_string: () => jsPsych.data.get().csv()
    };
    timeline.push(save_data);

    // Run it
    jsPsych.run(timeline);
  </script>
</body>
</html>
