<!DOCTYPE html>
<html>
<head>
  <title>Language Study</title>

  <!-- Load jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />

  <!-- Plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <!-- Stimuli -->
  <script src="experiment_stims.js"></script>
  <script src="fillers.js"></script>
  <script src="trial_stims.js"></script>

  <meta charset="UTF-8">

  <style>
    #jspsych-progressbar-container {
      background-color: #eee;
      border-radius: 12px;
      height: 20px;
      margin: 20px auto;
      width: 80%;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    #jspsych-progressbar-inner {
      background: linear-gradient(90deg, #fd53ab 0%, #ee55ae 100%);
      height: 100%;
      border-radius: 12px;
      transition: width 0.4s ease-in-out;
    }
  </style>
</head>

<body>
<script>
const jsPsych = initJsPsych({
  show_progress_bar: true,
  auto_update_progress_bar: false
});

const timeline = [];

// === Welcome screen ===
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="content">
      <h2>Welcome</h2>
      <p>You will read short dialogues, then a sentence one word at a time, followed by a comprehension question.</p>
      <p>This task will start with a few <strong>trial items</strong> so you can get familiar with the structure.</p>
      <p>You will get feedback during the trials.</p>
      <p>Press the <strong>SPACEBAR</strong> to begin the trials.</p>
    </div>`,
  choices: [' ']
});

// === Trial phase ===
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `<h2 style="text-align: center;">Trial Phase</h2><p style="text-align: center;">These are practice items. The real experiment will begin afterward.</p><p style="text-align: center;">Press the SPACEBAR to continue.</p>`,
  choices: [' ']
});

// === TRIAL BLOCK ===
trialStimuli.forEach((item, i) => {
  const trialBlock = [];

  trialBlock.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="width: 80vw; max-width: 700px; margin: auto;">
        <p style="text-align: center; font-weight: bold;">Trial Item ${i + 1} / ${trialStimuli.length}</p>
        <div style="font-size: 20px; white-space: pre-line; line-height: 1.5;">${item.dialogue}</div>
      </div>`,
    choices: [' ']
  });

  trialBlock.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '<p style="font-size: 32px;">+</p>',
    choices: "NO_KEYS",
    trial_duration: 500
  });

  item.spr.forEach((word, w) => {
    trialBlock.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p style="font-size: 32px;">${word}</p>`,
      choices: [' '],
      data: {
        type: "trial_spr",
        item_id: item.item_id,
        word,
        word_number: w + 1,
      },
      on_start: function () {
        jsPsych.setProgressBar((i + w / item.spr.length) / trialStimuli.length);
      },
      on_finish: function(data) {
        data.reading_time = data.rt;
      }
    });
  });

  trialBlock.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
      <div style="width: 80vw; max-width: 700px; margin: auto; font-size: 24px; line-height: 1.5; text-align: center;">
        <p>${item.question}</p>
        <p><strong>F</strong> = False, <strong>J</strong> = True</p>
      </div>`,
    choices: ['f', 'j'],
    data: {
      type: "trial_comprehension",
      item_id: item.item_id,
      correct_response: item.expected_response
    },
    on_finish: function(data) {
      const expected = data.correct_response.toLowerCase() === 't' ? 'j' : 'f';
      data.response_correct = data.response === expected;
    }
  });

  trialBlock.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: function() {
      const last = jsPsych.data.get().last(1).values()[0];
      return `<p style="font-size: 24px; text-align: center;">${
        last.response_correct ? "✅ Correct!" : "⚠️ Be more careful! That was the wrong answer."
      }</p><p style="text-align: center;">Press the SPACEBAR to continue.</p>`;
    },
    choices: [' ']
  });

  timeline.push(...trialBlock);
});

// === START OF REAL EXPERIMENT ===
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `<h2 style="text-align: center;">Main Experiment</h2><p style="text-align: center;">You are now starting the real experiment. There will be no feedback during this part.</p><p style="text-align: center;">Press SPACEBAR to begin.</p>`,
  choices: [' ']
});

// === GROUP LOGIC & ITEM SELECTION ===
const groups = ['A','B','C','D','E','F','G','H','I'];
const participant_group = jsPsych.randomization.sampleWithoutReplacement(groups, 1)[0];

const context_cycle = ['amb', 'dere', 'dedicto'];
const spr_rotation_map = {
  A: ['amb', 'dere', 'dedicto'],
  B: ['dere', 'dedicto', 'amb'],
  C: ['dedicto', 'amb', 'dere'],
  D: ['amb', 'dere', 'dedicto'],
  E: ['dere', 'dedicto', 'amb'],
  F: ['dedicto', 'amb', 'dere'],
  G: ['amb', 'dere', 'dedicto'],
  H: ['dere', 'dedicto', 'amb'],
  I: ['dedicto', 'amb', 'dere']
};
const spr_cycle = spr_rotation_map[participant_group];

const allTargetEntries = Object.entries(experimentStimuli);
const sampledTargets = jsPsych.randomization.sampleWithoutReplacement(allTargetEntries, 15);
const targetItems = sampledTargets.map(([item_id, data], index) => {
  const context_condition = context_cycle[index % 3];
  const spr_condition = spr_cycle[index % 3];
  return {
    type: "target",
    item_id,
    class: data.class,
    context_condition,
    spr_condition,
    dialogue: data[context_condition].dialogue,
    comprehension_question: data[context_condition].question,
    expected_response: data[context_condition].expected_response,
    sentence: data[spr_condition].spr
  };
});

const sampledFillers = jsPsych.randomization.sampleWithoutReplacement(fillerStimuli, 15);
const fillerItems = sampledFillers.map(f => ({
  type: "filler",
  item_id: f.item_id,
  class: f.class,
  context_condition: "filler",
  spr_condition: "filler",
  dialogue: f.dialogue,
  comprehension_question: f.question,
  expected_response: f.expected_response,
  sentence: f.spr
}));

const shuffledTargets = jsPsych.randomization.shuffle(targetItems);
const shuffledFillers = jsPsych.randomization.shuffle(fillerItems);

function interleaveBalanced(aList, bList) {
  const result = [];
  let a = 0, b = 0, last = "", streak = 0;

  while (a < aList.length || b < bList.length) {
    const useA = (
      (a < aList.length && (last !== "target" || streak < 2)) &&
      (b >= bList.length || last === "filler" && streak >= 2 || Math.random() < 0.5)
    );
    if (useA && a < aList.length) {
      result.push(aList[a++]);
      streak = (last === "target") ? streak + 1 : 1;
      last = "target";
    } else if (b < bList.length) {
      result.push(bList[b++]);
      streak = (last === "filler") ? streak + 1 : 1;
      last = "filler";
    }
  }

  return result;
}

const finalStimuli = interleaveBalanced(shuffledTargets, shuffledFillers);

// === MAIN EXPERIMENT TRIALS with MIDPOINT BREAK ===
function createTrial(item, index) {
  const trial = [];

  trial.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<div style="width: 80vw; max-width: 700px; margin: auto; font-size: 20px; white-space: pre-line; line-height: 1.5;">${item.dialogue}</div>`,
    choices: [' ']
  });

  trial.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: '<p style="font-size: 32px;">+</p>',
    choices: "NO_KEYS",
    trial_duration: 500
  });

  item.sentence.forEach((word, i) => {
    trial.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<p style="font-size: 32px;">${word}</p>`,
      choices: [' '],
      data: {
        type: "spr",
        word,
        word_number: i + 1,
        sentence_index: index + 1,
        item_id: item.item_id,
        class: item.class,
        condition: item.context_condition,
        spr_condition: item.spr_condition,
        participant_group: participant_group
      },
      on_finish: function(data) {
        data.reading_time = data.rt;
      },
      on_start: function () {
        jsPsych.setProgressBar((index + i / item.sentence.length) / finalStimuli.length);
      }
    });
  });

  trial.push({
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `<div style="width: 80vw; max-width: 700px; margin: auto; font-size: 24px; text-align: center;"> 
      <p>${item.comprehension_question}</p>
      <p><strong>F</strong> = False, <strong>J</strong> = True</p>
    </div>`,
    choices: ['f', 'j'],
    data: {
      type: "comprehension",
      item_id: item.item_id,
      class: item.class,
      context_condition: item.context_condition,
      spr_condition: item.spr_condition,
      participant_group: participant_group,
      correct_response: item.expected_response
    },
    on_finish: function(data) {
      const expected = data.correct_response.toLowerCase() === 't' ? 'j' : 'f';
      data.response_time = data.rt;
      data.response_correct = data.response === expected;
      data.response_type = data.response === expected ? 'match' : 'mismatch';
    }
  });

  return trial;
}

const halfway = Math.floor(finalStimuli.length / 2);
const firstHalf = finalStimuli.slice(0, halfway);
const secondHalf = finalStimuli.slice(halfway);

firstHalf.forEach((item, i) => {
  timeline.push(...createTrial(item, i));
});

timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="content">
      <h2>You’re halfway through!</h2>
      <p>You may take a short break if you'd like.</p>
      <p>Please keep your break under 2 minutes.</p>
      <p>Press the <strong>SPACEBAR</strong> to continue when you're ready.</p>
    </div>`,
  choices: [' ']
});

secondHalf.forEach((item, i) => {
  timeline.push(...createTrial(item, halfway + i));
});

// === END MESSAGE ===
timeline.push({
  type: jsPsychHtmlKeyboardResponse,
  stimulus: `
    <div class="content">
      <h2>Thank you!</h2>
      <p>The experiment is complete.</p>
      <p>Press SPACEBAR to view your data.</p>
    </div>`,
  choices: [' '],
  on_finish: function () {
    jsPsych.data.displayData();
  }
});

// === SAVE ===
const subject_id = jsPsych.randomization.randomID(10);
const filename = `${subject_id}.csv`;

timeline.push({
  type: jsPsychPipe,
  action: "save",
  experiment_id: "kmddDMNYDI1g",
  filename: filename,
  data_string: () => jsPsych.data.get().csv()
});

jsPsych.run(timeline);
</script>
</body>
</html>