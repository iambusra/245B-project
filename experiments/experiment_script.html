<!DOCTYPE html>
<html>
<head>
  <title>Language Study</title>

  <!-- Load jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.3"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" />

  <!-- Plugins -->
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

  <!-- Stimuli file -->
  <script src="experiment_stims.js"></script>

  <meta charset="UTF-8">

  <style>
    #jspsych-progressbar-container {
      background-color: #eee;
      border-radius: 12px;
      height: 20px;
      margin: 20px auto;
      width: 80%;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    #jspsych-progressbar-inner {
      background: linear-gradient(90deg, #fd53ab 0%, #ee55ae 100%);
      height: 100%;
      border-radius: 12px;
      transition: width 0.4s ease-in-out;
    }
  </style>
</head>

<body>
  <script>
    const jsPsych = initJsPsych({
      show_progress_bar: true,
      auto_update_progress_bar: false
    });

    const timeline = [];

    // 9 participant groups
    const groups = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'];
    const participant_group = jsPsych.randomization.sampleWithoutReplacement(groups, 1)[0];

    // context and SPR condition cycles
    const context_cycle = ['amb', 'dere', 'dedicto'];
    const spr_rotation_map = {
      A: ['amb', 'dere', 'dedicto'],
      B: ['dere', 'dedicto', 'amb'],
      C: ['dedicto', 'amb', 'dere'],
      D: ['amb', 'dere', 'dedicto'],
      E: ['dere', 'dedicto', 'amb'],
      F: ['dedicto', 'amb', 'dere'],
      G: ['amb', 'dere', 'dedicto'],
      H: ['dere', 'dedicto', 'amb'],
      I: ['dedicto', 'amb', 'dere']
    };
    const spr_cycle = spr_rotation_map[participant_group];

    // Convert dictionary to array of entries
    const orderedItems = Object.entries(experimentStimuli).map(([item_id, data], index) => {
      const context_condition = context_cycle[index % 3];
      const spr_condition = spr_cycle[index % 3];

      return {
        item_id: item_id,
        class: data.class,
        context_condition: context_condition,
        spr_condition: spr_condition,
        dialogue: data[context_condition].dialogue,
        comprehension_question: data[context_condition].question,
        expected_response: data[context_condition].expected_response,
        sentence: data[spr_condition].spr
      };
    });

    const shuffledStimuli = jsPsych.randomization.shuffle(orderedItems);

    // INSTRUCTIONS
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="content">
          <h2>Welcome</h2>
          <p>You will read short dialogues, then a sentence one word at a time, followed by a comprehension question.</p>
          <p>Press the <strong>SPACEBAR</strong> to begin.</p>
        </div>`,
      choices: [' ']
    });

    // CREATE TRIALS
    function createTrial(item, index) {
      const trial = [];

      // 1. DIALOGUE
      trial.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="width: 80vw; max-width: 700px; margin: auto; font-size: 20px; white-space: pre-line; line-height: 1.5;">
            ${item.dialogue}
          </div>`,
        choices: [' ']
      });

      // 2. FIXATION
      trial.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p style="font-size: 32px;">+</p>',
        choices: "NO_KEYS",
        trial_duration: 500
      });

      // 3. SPR SENTENCE
      item.sentence.forEach((word, i) => {
        trial.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size: 32px;">${word}</p>`,
          choices: [' '],
          data: {
            type: "spr",
            word: word,
            word_number: i + 1,
            sentence_index: index + 1,
            item_id: item.item_id,
            class: item.class,
            context_condition: item.context_condition,
            spr_condition: item.spr_condition,
            participant_group: participant_group
          },
          on_finish: function(data) {
            data.reading_time = data.rt;
          },
          on_start: function () {
            jsPsych.setProgressBar((index + i / item.sentence.length) / shuffledStimuli.length);
          }
        });
      });

      // 4. COMPREHENSION QUESTION
      trial.push({
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div style="width: 80vw; max-width: 700px; margin: auto; font-size: 24px; line-height: 1.5; text-align: center;">
            <p>${item.comprehension_question}</p>
            <p><strong>F</strong> = False, <strong>J</strong> = True</p>
          </div>`,
        choices: ['f', 'j'],
        data: {
          type: "comprehension",
          item_id: item.item_id,
          class: item.class,
          context_condition: item.context_condition,
          spr_condition: item.spr_condition,
          participant_group: participant_group,
          correct_response: item.expected_response
        },
        on_finish: function(data) {
          const expected = data.correct_response.toLowerCase() === 't' ? 'j' : 'f';
          data.response_time = data.rt;
          data.response_correct = data.response === expected;
          data.response_type = data.response === expected ? 'match' : 'mismatch';
        }
      });

      return trial;
    }

    // ADD ALL TRIALS
    shuffledStimuli.forEach((item, i) => {
      timeline.push(...createTrial(item, i));
    });

    // END MESSAGE
    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="content">
          <h2>Thank you!</h2>
          <p>The experiment is complete.</p>
          <p>Press SPACEBAR to view your data.</p>
        </div>`,
      choices: [' '],
      on_finish: function () {
        jsPsych.data.displayData();
      }
    });

    // SAVE TO OSF
    const subject_id = jsPsych.randomization.randomID(10);
    const filename = `${subject_id}.csv`;

    timeline.push({
      type: jsPsychPipe,
      action: "save",
      experiment_id: "kmddDMNYDI1g",
      filename: filename,
      data_string: () => jsPsych.data.get().csv()
    });

    // RUN EXPERIMENT
    jsPsych.run(timeline);
  </script>
</body>
</html>